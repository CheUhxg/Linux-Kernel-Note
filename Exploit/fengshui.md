# 堆风水技术

## 堆分配器

Linux 内核可以使用以下几种分配器之一：SLOB、SLUB 或 SLAB。不同的 Linux 发行版使用不同的分配器。
* SLOB 通常用于嵌入式系统
* SLUB 是目前最常用的分配器，专为大型系统设计
* SLAB 是最古老的分配器，源自 Solaris

> TODO: 补充https://sam4k.com/linternals-memory-allocators-0x02/。

## 堆喷射

堆喷射（Heap Spraying）是一种利用技术，旨在将受控字节放置在堆中某个预定的内存位置。堆喷射通常涉及分配多个具有受控内容的堆对象，并滥用内存分配器的行为模式。

每次堆喷射都涉及通过循环调用某个函数来生成特定对象的内存实例。在这个例子中，调用/dev/ptmx的open()函数会在堆内存中生成tty_struct对象。

堆喷射还有一个特点：**当 kmalloc() 被调用时，slab 分配器会返回最近被释放的内存地址**。

|结构体|触发方式|所在缓存|
|-|-|-|
|tty_struct|open("/dev/ptmx", O_RDONLY \| O_NOCTTY);（分配）<br>ioctl(spray[i], rcx, rdx);（调用ops）|kmalloc-?|
|msg_msg|msgsnd(msqid, &msg, sizeof(msg.mtext), 0);（分配）|[kmalloc-64, kmalloc-4k]|
|user_key_payload|add_key("user", name_buf, buf, size, flag)（分配）|kmalloc-?|
|anon_vma_name|prctl(PR_SET_VMA, PR_SET_VMA_ANON_NAME, ptr, size, name);（分配）<br>read(</proc/pid/maps>);（泄漏）|[kmalloc-8, kmalloc-96]|

# 参考

1. https://santaclz.github.io/2024/01/20/Linux-Kernel-Exploitation-Heap-techniques.html
2. https://sam4k.com/linternals-memory-allocators-0x02/
3. https://a13xp0p0v.github.io/2020/11/30/slab-quarantine.html